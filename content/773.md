Title: Załączniki w e-mailach w Drupalu 7
Date: 2013-07-15 11:52
Author: filipgorczynski
Category: Programowanie, Rozwiązania
Tags: charset, content-type, drupal 7, drupal_mail, e-mail, hook_mail, HTML, mime-type, Swift Mailer, załączniki
Slug: 773
Status: draft

\[code language="php"\]

\<?php  
require\_once 'loss\_report.class.php';  
module\_load\_include('inc', 'pathauto');

\$allowed\_file\_extensions = array('pdf doc docx xls xlsx txt gif png jpg jpeg');  
\$allowed\_upload\_max\_filesize = array(ini\_get('upload\_max\_filesize'));  
\$upload\_validators = array(  
'file\_validate\_extensions' =\> array('pdf doc docx xls xlsx txt gif png jpg jpeg'),  
'file\_validate\_size' =\> array(ini\_get('upload\_max\_filesize')),  
);  
/\*\*  
\* Implements hook\_permission().  
\*/  
function loss\_report\_permission() {  
return array(  
'access loss report setting' =\> array(  
'title' =\> t('Access loss report form'),  
'description' =\> t('Perform administration tasks for my module.'),  
),  
'administer loss report form' =\> array(  
'title' =\> t('Administer loss report submissions'),  
'description' =\> t('Perform administration tasks for my module.'),  
),  
);  
}  
/\*\*  
\* Implements hook\_menu().  
\*/  
function loss\_report\_menu() {  
\$items\['loss-report'\] = array(  
'title' =\> 'Loss report',  
'page callback' =\> 'drupal\_get\_form',  
'page arguments' =\> array('loss\_report\_form'),  
'access arguments' =\> array('access loss report form'),  
'type' =\> MENU\_NORMAL\_ITEM,  
);  
\$items\['admin/config/loss-reports'\] = array(  
'title' =\> 'Loss report settings',  
'page callback' =\> 'drupal\_get\_form',  
'page arguments' =\> array('loss\_reports\_settings\_form'),  
'access arguments' =\> array('access loss report form'),  
'type' =\> MENU\_NORMAL\_ITEM,  
);  
\$items\['admin/content/loss-reports'\] = array(  
'title' =\> 'Loss reports',  
'page callback' =\> 'drupal\_get\_form',  
'page arguments' =\> array('loss\_report\_form'),  
'access arguments' =\> array('administer loss report form'),  
'type' =\> MENU\_NORMAL\_ITEM,  
);  
return \$items;  
}  
/\*\*  
\* Implements hook\_form().  
\* \@todo add removing fields  
\*/  
function loss\_report\_form(\$form, &\$form\_state) {  
\$categoryTree = LossReport::getCategoryTree();  
\$categories = LossReport::getLossCategories();  
\$form = array();  
\$form\['\#tree'\] = true;  
\$form\['\#attributes'\]\['enctype'\] = 'multipart/form-data';  
\$loss\_report\_general\_information = variable\_get('loss\_report\_general\_information', array(  
'value' =\> '',  
'format' =\> filter\_default\_format(),  
));  
\$form\['general\_information'\] = array(  
'\#markup' =\> \$loss\_report\_general\_information\['value'\],  
);  
\$form\['header\_1'\] = array(  
'\#markup' =\> t('Select loss report'),  
);  
\$form\['loss\_categories'\] = array(  
'\#type' =\> 'select',  
'\#title' =\> t('Category'),  
'\#options' =\> array\_merge(array('' =\> t('-- Select category --')), \$categories),  
'\#default\_value' =\> !empty(\$form\_state\['loss\_categories'\])? \$form\_state\['loss\_categories'\]: '',  
'\#required' =\> true,  
);  
\$form\['header\_2'\] = array(  
'\#markup' =\> t('Data injured'),  
);  
\$form\['loss\_report'\] = array(  
'firstname' =\> array(  
'\#type' =\> 'textfield',  
'\#attributes' =\> array('class' =\> 'input'),  
'\#title' =\> t('First name'),  
'\#description' =\> t(''),  
'\#attributes' =\> array('class' =\> 'input'),  
'\#required' =\> true,  
),  
'lastname' =\> array(  
'\#type' =\> 'textfield',  
'\#attributes' =\> array('class' =\> 'input'),  
'\#title' =\> t('Last name'),  
'\#attributes' =\> array('class' =\> 'input'),  
'\#description' =\> t(''),  
'\#required' =\> true,  
),  
'loss\_number' =\> array(  
'\#type' =\> 'textfield',  
'\#attributes' =\> array('class' =\> 'input'),  
'\#title' =\> t('Loss number'),  
'\#attributes' =\> array('class' =\> 'input'),  
'\#description' =\> t(''),  
'\#required' =\> true,  
),  
'plate\_number' =\> array(  
'\#type' =\> 'textfield',  
'\#attributes' =\> array('class' =\> 'input'),  
'\#title' =\> t('Plate numbers'),  
'\#attributes' =\> array('class' =\> 'input'),  
'\#description' =\> t(''),  
'\#required' =\> true,  
),  
'message' =\> array(  
'\#type' =\> 'textarea',  
'\#attributes' =\> array('class' =\> 'input'),  
'\#title' =\> t('Message'),  
'\#attributes' =\> array('class' =\> 'input'),  
'\#description' =\> t(''),  
'\#required' =\> true,  
),  
);  
\$form\['header\_3'\] = array(  
'\#markup' =\> t('Attachments'),  
);  
foreach (\$categories as \$cid =\> \$value) {  
\$form\["loss\_container\_{\$cid}"\] = array(  
'\#type' =\> 'container',  
'\#prefix' =\> '\<div id="edit-loss-container-' . \$cid . '" class="form-wrapper" style="display: none"\>',  
'\#suffix' =\> '\</div\>',  
'\#states' =\> array(  
'visible' =\> array(  
'select\[name="loss\_categories"\]' =\> array(  
'value' =\> \$cid  
),  
),  
),  
'files\_container' =\> array(  
'\#type' =\> 'fieldset',  
'\#title' =\> t('Files'),  
),  
);

foreach (\$categoryTree\[\$cid\]\['subcategory'\] as \$sid =\> \$names) {  
\$form\["loss\_container\_{\$cid}"\]\['files\_container'\]\["checkbox\_{\$cid}\_{\$sid}"\] = array(  
'\#type' =\> 'checkbox',  
'\#title' =\> \$names\[0\],  
'\#prefix' =\> '\<div\>',  
'\#suffix' =\> '\</div\>',  
);  
if (empty(\$form\_state\["add\_more\_file\_{\$cid}\_{\$sid}\_counter"\]))  
\$form\_state\["add\_more\_file\_{\$cid}\_{\$sid}\_counter"\] = 1;

\$cbx\_name = "loss\_container\_{\$cid}\[files\_container\]\[checkbox\_{\$cid}\_{\$sid}\]";  
\$cbx\_container = "edit-loss-container-{\$cid}-files-container-checkbox-{\$cid}-{\$sid}-cbx-container";  
\$files\_container = "edit-loss-container-{\$cid}-files-container-checkbox-{\$cid}-{\$sid}-files-container";

\$form\["loss\_container\_{\$cid}"\]\['files\_container'\]\["checkbox\_{\$cid}\_{\$sid}-cbx\_container"\] = array(  
'\#type' =\> 'container',  
'\#prefix' =\> '\<div id="' . \$cbx\_container . '" class="form-wrapper" style="display: none"\>',  
'\#suffix' =\> '\</div\>',  
'\#states' =\> array(  
'visible' =\> array(  
':input\[name="' . \$cbx\_name . '"\]' =\> array(  
'checked' =\> true  
),  
),  
),  
'files' =\> array(  
'\#type' =\> 'container',  
'\#prefix' =\> '\<div id="' . \$files\_container . '" class="form-wrapper"\>',  
'\#suffix' =\> '\</div\>',  
),  
"add\_more\_file\_{\$cid}\_{\$sid}" =\> array(  
'\#type' =\> 'submit',  
'\#name' =\> "add\_more\_file\_{\$cid}\_{\$sid}",  
'\#value' =\> t('Add another file'),  
'\#limit\_validation\_errors' =\> array(),  
'\#submit' =\> array('loss\_reports\_add\_more\_file'),  
'\#ajax' =\> array(  
'wrapper' =\> \$files\_container,  
'callback' =\> 'loss\_report\_add\_more\_callback',  
'method' =\> 'append',  
'effect' =\> 'fade',  
),  
),  
);

for (\$i = 1; \$i \<= \$form\_state\["add\_more\_file\_{\$cid}\_{\$cid}\_counter"\]; \$i++) {  
\$keys = array(  
"loss\_container\_{\$cid}",  
'files\_container',  
"checkbox\_{\$cid}\_{\$sid}-cbx\_container",  
'files',  
'file',  
);  
\$file\_field\[\$i\] = array(  
'\#type' =\> 'managed\_file',  
'\#title' =\> t('Add file'),  
'\#upload\_location' =\> 'public://',  
'\#upload\_validators' =\> array(  
'file\_validate\_extensions' =\> array('pdf doc docx xls xlsx txt gif png jpg jpeg'),  
'file\_validate\_size' =\> array(ini\_get('upload\_max\_filesize')),  
),  
);  
drupal\_array\_set\_nested\_value(\$form, \$keys, \$file\_field);  
}  
}  
}  
\$form\['submit'\] = array(  
'\#type' =\> 'submit',  
'\#value' =\> t('Send'),  
);  
return \$form;  
}  
function loss\_report\_add\_more\_callback(\$form, &\$form\_state) {  
\$parents = \$form\_state\['triggering\_element'\]\['\#parents'\];  
\$name = array\_pop(\$parents) . '\_counter';  
\$last\_file\_id = \$form\_state\[\$name\];  
\$file = drupal\_array\_get\_nested\_value(\$form, array\_merge(\$parents, array('files', 'file')));

return \$file\[\$last\_file\_id\];  
}  
function loss\_reports\_add\_more\_file(\$form, &\$form\_state) {  
\$parents = \$form\_state\['triggering\_element'\]\['\#parents'\];  
\$name = \$parents\[count(\$parents) - 1\] . '\_counter';  
\$form\_state\[\$name\]++;  
\$form\_state\['rebuild'\] = true;  
}  
function loss\_reports\_remove\_file(\$form, &\$form\_state) {  
// \@todo Should I remove files from storage?  
\$parents = \$form\_state\['triggering\_element'\]\['\#parents'\];  
\$name = \$parents\[count(\$parents) - 1\];  
if (\$form\_state\[\$name\] \> 1)  
\$form\_state\[\$name\]--;  
\$form\_state\['rebuild'\] = true;  
}  
/\*\*  
\* Implements hook\_form\_submit().  
\*/  
function loss\_report\_form\_submit(\$form, &\$form\_state) {  
\$categoryTree = LossReport::getCategoryTree();  
extract(\$form\_state\['values'\]\['loss\_report'\]);  
\$cid = \$form\_state\['values'\]\['loss\_categories'\];  
\$module = 'loss\_report';  
\$key = 'filesend';  
\$to = variable\_get('loss\_report\_mailto', 'f.gorczynski\@merixstudio.com');  
\$language = language\_default();  
\$from = variable\_get('site\_mail', 'zgloszenie\@localmail.com');  
\$send = true;  
\$files = \$form\_state\['values'\]\["loss\_container\_{\$cid}"\]\['files\_container'\];  
foreach (\$categoryTree\[\$cid\]\['subcategory'\] as \$sid =\> \$names) {  
\$uploaded = \$files\["checkbox\_{\$cid}\_{\$sid}-cbx\_container"\]\['files'\]\['file'\];  
\$form\_state\['values'\]\['cid'\] = \$cid;  
\$form\_state\['values'\]\['sid'\] = \$sid;  
foreach (\$uploaded as \$id =\> \$fid)  
if (\$fid \> 0) {  
\$form\_state\['values'\]\['fid'\] = \$fid;  
drupal\_mail(\$module, \$key, \$to, \$language, \$form\_state\['values'\], \$from, \$send);  
}  
}

drupal\_set\_message(t('The form has been submitted and the files has beed send'));  
}  
function loss\_report\_mail(\$key, &\$mail\_message, \$params) {  
switch(\$key) {  
case 'filesend':  
\$categoryTree = LossReport::getCategoryTree();  
extract(\$params\['loss\_report'\]);  
\$cid = \$params\['cid'\];  
\$sid = \$params\['sid'\];  
\$fid = \$params\['fid'\];  
\$category\_name = \$categoryTree\[\$cid\]\['category'\];  
\$subcategory\_name = \$categoryTree\[\$cid\]\['subcategory'\]\[\$sid\]\[1\];

\$mail\_message\['format'\] = 'text/html';  
\$mail\_message\['charset'\] = 'UTF-8';  
\$mail\_message\['subject'\] = "{\$loss\_number}, {\$firstname} {\$lastname} {\$category\_name} {\$subcategory\_name}";  
\$mail\_message\['body'\]\[\] = t('First name') . ': '. \$firstname;  
\$mail\_message\['body'\]\[\] = t('Last name') . ': '. \$lastname;  
\$mail\_message\['body'\]\[\] = t('Loss number') . ': '. \$loss\_number;  
\$mail\_message\['body'\]\[\] = t('Plate numbers') . ': '. \$plate\_number;  
\$mail\_message\['body'\]\[\] = t('Message') . ': '. \$message;  
\$mail\_message\['params'\]\['files'\]\[\] = file\_load(\$fid, true);  
break;  
}  
}  
/\*\*  
\* Implements settings form for Loss report module  
\*/  
function loss\_reports\_settings\_form(\$form, &\$form\_state) {  
\$form = array();  
\$loss\_report\_general\_information = variable\_get('loss\_report\_general\_information', array(  
'value' =\> '',  
'format' =\> filter\_default\_format(),  
));  
\$form\['loss\_report\_general\_information'\] = array(  
'\#type' =\> 'text\_format',  
'\#title' =\> t('Loss report general information - header text'),  
'\#default\_value' =\> \$loss\_report\_general\_information\['value'\],  
'\#format' =\> \$loss\_report\_general\_information\['format'\],  
);  
\$form\['loss\_report\_mailto'\] = array(  
'\#type' =\> 'textfield',  
'\#title' =\> t('Loss report mail to'),  
'\#default\_value' =\> variable\_get('loss\_report\_mailto', ''),  
);  
\$form\['loss\_upload\_location'\] = array(  
'\#type' =\> 'textfield',  
'\#title' =\> t('Loss upload location'),  
'\#default\_value' =\> variable\_get('loss\_upload\_location', ''),  
);  
return system\_settings\_form(\$form);  
}  
\[/code\]
